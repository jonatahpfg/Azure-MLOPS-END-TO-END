# ===================================================================
# GITHUB ACTIONS - CI/CD PIPELINE
# ===================================================================
# Workflow autom√°tico para treinar e deployar modelo
# Trigger: push para main ou pull request
# ===================================================================

name: MLOps Pipeline - Churn Prediction

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Permite execu√ß√£o manual

env:
  PYTHON_VERSION: '3.10'
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_WORKSPACE_NAME: ${{ secrets.AZURE_WORKSPACE_NAME }}

defaults:
  run:
    working-directory: ./ml-project

jobs:
  # ========================================================================
  # JOB 1: LINT E TESTES
  # ========================================================================
  lint-and-test:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    
    
    

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest black
          pip install -r requirements.txt
      
      - name: üîç Run Flake8 (Linter)
        run: |
          flake8 src/ pipelines/ --max-line-length=120 --ignore=E203,W503
        continue-on-error: true

  # ========================================================================
  # JOB 2: TREINAR MODELO NO AZURE ML
  # ========================================================================
  train-model:
    name: Train ML Model
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üì¶ Install Azure ML SDK
        run: |
          python -m pip install --upgrade pip
          # For√ßa vers√£o compat√≠vel do marshmallow para n√£o dar erro
          pip install marshmallow==3.21.0
          
          pip install azure-ai-ml azure-identity azureml-core mlflow
          pip install -r requirements.txt
      
      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
    
      
      - name: üöÄ Submit Training Pipeline
        run: |
          python submit_job.py \
            --subscription_id ${{ env.AZURE_SUBSCRIPTION_ID }} \
            --resource_group ${{ env.AZURE_RESOURCE_GROUP }} \
            --workspace_name ${{ env.AZURE_WORKSPACE_NAME }} \
            --model_type all \
            --experiment_name "churn-experiment-v1" \
            --wait_for_completion true
      
      - name: üìù Log Pipeline Info
        run: |
          echo "‚úÖ Pipeline de treino submetido com sucesso!"
          echo "üìä Verifique m√©tricas no Azure ML Studio"

  # ========================================================================
  # JOB 3: DEPLOY (APENAS SE PASSOU NOS GATES)
  # ========================================================================
  deploy-model:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: train-model
    if: github.ref == 'refs/heads/main'
    environment:  production 
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üì¶ Install Dependencies
        run: |
          pip install azure-ai-ml azure-identity
      
      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: üö¢ Deploy Model
        run: |
          python src/deploy/deploy_model.py \
            --subscription_id ${{ env.AZURE_SUBSCRIPTION_ID }} \
            --resource_group ${{ env.AZURE_RESOURCE_GROUP }} \
            --workspace_name ${{ env.AZURE_WORKSPACE_NAME }} \
            --model_name "TelcoChurnModel" \
            --endpoint_name "churn-endpoint-v8" \
            --deployment_name "churn-v${{ github.run_number }}" \
            --instance_type "Standard_D2as_v4" \
            --instance_count 1
      

      - name: ‚úÖ Deployment Complete
        run: |
          echo "üéâ Modelo deployado com sucesso!"
         

# ===================================================================
# SECRETS NECESS√ÅRIOS (Configuradas no GitHub secrets)
# ===================================================================
# AZURE_CREDENTIALS: JSON com service principal
# AZURE_SUBSCRIPTION_ID: ID da subscription
# AZURE_RESOURCE_GROUP: Nome do resource group
# AZURE_WORKSPACE_NAME: Nome do workspace
# ===================================================================

#FORCE DEPLOYMENT
